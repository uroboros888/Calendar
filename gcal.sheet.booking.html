<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yacht Calendar — Viewer + Booking (Sheet Pricing)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .tn-nums{font-variant-numeric: tabular-nums;}
    .sheet-enter{transform:translateY(100%)}
    .sheet-open{transform:translateY(0)}
    .sheet{transition:transform .25s ease;}
    .slot-selected{outline:2px solid #6366f1; outline-offset:-2px;}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100 text-gray-900">
  <div id="app" class="mx-auto px-4 py-6 max-w-5xl"></div>

  <script>
  const STORAGE_KEY='yachtCalendarConfigSheet';
  const TZ='Asia/Dubai';
  const fmt = (d, opts={}) => new Intl.DateTimeFormat('en', {...opts, timeZone: TZ}).format(d);
  const DOW_SHORT_TO_KEY = { Sun:'sunday', Mon:'monday', Tue:'tuesday', Wed:'wednesday', Thu:'thursday', Fri:'friday', Sat:'saturday' };

  const app=document.getElementById('app');
  const __logs=[];

  function log(){
    try{
      console.log.apply(console, arguments);
      __logs.push(Array.from(arguments).map(x=> typeof x==='object'? JSON.stringify(x): String(x)).join(' '));
    }catch{}
  }

  function renderError(title, message){
    const details = __logs.slice(-30).join('\n');
    app.innerHTML = `
      <div class="max-w-md mx-auto text-center bg-white rounded-2xl shadow p-6">
        <h2 class="font-semibold text-lg mb-2">${title}</h2>
        <div class="text-sm text-gray-600 whitespace-pre-wrap">${message}</div>
        <div class="mt-4 flex flex-wrap gap-2 justify-center">
          <button class="px-3 py-2 rounded-lg bg-indigo-600 text-white" onclick="location.reload()">Retry</button>
          <a class="px-3 py-2 rounded-lg bg-white border" href="mailto:support@example.com?subject=Yacht%20Calendar%20Support" rel="noopener">Contact Support</a>
          <button class="px-3 py-2 rounded-lg bg-white border" onclick="navigator.clipboard&&navigator.clipboard.writeText(document.getElementById('dbg').innerText)">Copy logs</button>
        </div>
        <pre id="dbg" class="text-left mt-3 p-2 bg-gray-50 rounded max-h-64 overflow-auto text-xs">${details}</pre>
      </div>`;
  }

  window.addEventListener('error', (e)=>{ renderError('Runtime error', e.message||'unknown'); });
  window.addEventListener('unhandledrejection', (e)=>{ renderError('Unhandled promise', String(e.reason||e)); });

  async function loadConfig(){
    if(location.protocol==='file:'){
      throw new Error('config.json cannot be loaded over file://. Please serve via http(s).');
    }
    const res = await fetch('config.json', {cache:'no-store'});
    if(!res.ok){ throw new Error('Failed to load config.json ('+res.status+')'); }
    const cfg = await res.json();
    try{
      let uid = localStorage.getItem('yachtCalendar.uid');
      if(!uid){ uid = (crypto && crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,10))); localStorage.setItem('yachtCalendar.uid', uid); }
      cfg.clientUid = uid;
      cfg.userAgent = navigator.userAgent || '';
      const url = new URL(location.href);
      const userFromUrl = url.searchParams.get('user') || url.searchParams.get('u');
      if(userFromUrl){ localStorage.setItem('yachtCalendar.user', userFromUrl); }
      cfg.userId = localStorage.getItem('yachtCalendar.user') || '';
      // allowOffHours toggle via config or URL (?offhours=1)
      const oh = url.searchParams.get('offhours');
      if(oh==='1'){ cfg.allowOffHours = true; }
    }catch{}
    return cfg;
  }

  function pad2(n){ return String(n).padStart(2,'0'); }

  function zonedDateParts(date, timeZone){
    const parts = new Intl.DateTimeFormat('en-CA',{timeZone,year:'numeric',month:'2-digit',day:'2-digit',weekday:'short',hour:'2-digit',minute:'2-digit',hour12:false}).formatToParts(date);
    const map={}; parts.forEach(p=> map[p.type]=p.value);
    return { y: Number(map.year), m: Number(map.month), d: Number(map.day), wd: map.weekday, h: Number(map.hour), mi: Number(map.minute) };
  }

  function isoDateInTZ(date, timeZone){ const p=zonedDateParts(date,timeZone); return `${p.y}-${pad2(p.m)}-${pad2(p.d)}`; }
  function addDays(d, n){ const x=new Date(d); x.setUTCDate(x.getUTCDate()+n); return x; }
  function addMinutes(date, mins){ const d=new Date(date); d.setMinutes(d.getMinutes()+mins); return d; }

  function hmToMinutes(str){
    const parts = String(str||'0:0').split(':');
    const hh = Number(parts[0])||0;
    const mm = Number(parts[1])||0;
    return hh*60 + mm;
  }

  function minutesDiffWrap(start, end){
    let diff = end - start;
    if (diff <= 0) diff += 24*60;
    return diff;
  }

  function dateAtMinutes(ymd, minutes){
    const base = new Date(`${ymd}T00:00:00+04:00`);
    return new Date(base.getTime() + minutes*60000);
  }

  function random(seed){ return ()=> (seed = (seed*9301 + 49297) % 233280) / 233280; }

  function demoEventsForWeek(weekStartInTz, seed, openHM='08:00', closeHM='23:00'){
    const out=[]; const rnd=random(seed);
    for(let d=0; d<7; d++){
      const ymd = isoDateInTZ(addDays(weekStartInTz,d), TZ);
      let cursor = dateAtMinutes(ymd, hmToMinutes(openHM));
      const closeMin = hmToMinutes(closeHM);
      const dayEnd = dateAtMinutes(ymd, closeMin>=24*60? (closeMin-1): closeMin);
      const n = 1 + Math.floor(rnd()*3);
      for(let i=0;i<n;i++){
        const startOffset = (Math.floor(rnd()*9))*30;
        const dur = (2 + Math.floor(rnd()*9))*30;
        const start = addMinutes(cursor, startOffset);
        let end = addMinutes(start, dur);
        if(end>dayEnd) end=dayEnd;
        cursor = addMinutes(end, (Math.floor(rnd()*5))*30);
        out.push({start, end});
      }
    }
    return out;
  }

  async function fetchJson(url, timeoutMs=15000){
    const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res= await fetch(url,{signal:ctrl.signal});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } finally{ clearTimeout(t); }
  }

  function fetchJsonp(url, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      const cb = `yc_cb_${Date.now()}_${Math.floor(Math.random()*1e6)}`;
      const sep = url.includes('?') ? '&' : '?';
      const src = `${url}${sep}callback=${cb}&_=${Date.now()}`;
      const s = document.createElement('script');
      let done=false;
      const timer=setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
      function cleanup(){ if(done) return; done=true; clearTimeout(timer); delete window[cb]; if(s.parentNode) s.parentNode.removeChild(s); }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
      s.src = src; document.head.appendChild(s);
    });
  }

  function cacheGet(key, ttlMs){ try{ const raw=localStorage.getItem(key); if(!raw) return null; const obj=JSON.parse(raw); if(Date.now()-obj.t>ttlMs) return null; return obj.v; }catch{ return null; } }
  function cacheSet(key, v){ try{ localStorage.setItem(key, JSON.stringify({t:Date.now(), v})); }catch{} }

  function shouldUseJsonp(url){ return /script\.googleusercontent\.com|script\.google\.com/.test(url); }

  function makeUrl(base, params){
    const u = new URL(base, location.href);
    Object.keys(params||{}).forEach(k=>{ if(params[k]!==undefined && params[k]!==null) u.searchParams.set(k, params[k]); });
    return u.toString();
  }

  async function fetchPricingConfig(cfg){
    const base = cfg.pricingEndpointUrl || cfg.endpointUrl;
    const extra = {};
    if(cfg.useTestCalendars) extra.test = 1;
    if(cfg.clientUid) extra.uid = cfg.clientUid;
    if(cfg.userId) extra.user = cfg.userId;
    if(cfg.userAgent) extra.ua = cfg.userAgent;
    const url = cfg.pricingEndpointUrl ? makeUrl(base, { client:'viewer', ...extra }) : makeUrl(base, { mode: 'pricing', client:'viewer', ...extra });
    const data = shouldUseJsonp(url) ? await fetchJsonp(url) : await fetchJson(url);
    if(data && data._nameById) delete data._nameById;
    return data;
  }

  function overlapMinutes(aStart, aEnd, bStart, bEnd){
    const start = Math.max(aStart.getTime(), bStart.getTime());
    const end = Math.min(aEnd.getTime(), bEnd.getTime());
    return start < end ? (end - start) / 60000 : 0;
  }

  function computeOccupancy(boats, dayYMD, getHours){
    const busy = {}; const total = {};
    boats.forEach(b=>{ busy[b.id]=0; total[b.id]=0; });
    dayYMD.forEach(ymd=>{
      const hrs = (typeof getHours==='function')? getHours(ymd) : {open: '08:00', close: '24:00'};
      const openMin = hmToMinutes(hrs.open);
      const closeMin = hmToMinutes(hrs.close);
      const duration = minutesDiffWrap(openMin, closeMin);
      const dayStart = dateAtMinutes(ymd, openMin);
      const dayEnd = new Date(dayStart.getTime() + duration*60000);
      boats.forEach(b=>{
        total[b.id] += duration;
        (b.events||[]).forEach(ev=>{
          const s = new Date(ev.start);
          const e = new Date(ev.end);
          const overlap = overlapMinutes(s,e,dayStart,dayEnd);
          if(overlap>0){ busy[b.id]+=overlap; }
        });
      });
    });
    const result={};
    boats.forEach(b=>{
      const busyMinutes = busy[b.id]||0;
      const totalMinutes = (total[b.id]||0);
      const ratio = totalMinutes>0? Math.max(0, Math.min(1, busyMinutes/totalMinutes)) : 0;
      result[b.id]={ busyMinutes, totalMinutes, ratio };
    });
    return result;
  }

  function resolveBusyInfo(levels, ratio, boatId){
    if(!levels || !levels.length || ratio===null || ratio===undefined) return null;
    for(const level of levels){
      const from = typeof level.from==='number'? level.from : Number(level.from)||0;
      const toRaw = level.to;
      const to = (toRaw===null || toRaw===undefined || toRaw==='') ? null : Number(toRaw);
      const inRange = ratio >= from && (to===null ? ratio <= 1 : ratio <= to + 1e-9);
      if(inRange){
        const mult = level.multipliers && (level.multipliers[boatId] ?? level.multipliers['*'] ?? level.multipliers.default);
        return { from, to, mult: (isFinite(mult)&&!isNaN(mult))? Number(mult): null };
      }
    }
    return null;
  }

  function resolveBandMultiplier(bands, minute, boatId){
    for(const band of bands){
      const start = Number(band.startMinutes);
      const end = Number(band.endMinutes);
      if(!isFinite(start) || !isFinite(end)) continue;
      let match;
      if(start === end){ match = true; }
      else if(start < end){ match = minute >= start && minute < end; }
      else { match = minute >= start || minute < end; }
      if(match){
        const multipliers = band.multipliers || {};
        const val = multipliers[boatId] ?? multipliers['*'] ?? multipliers.default;
        if(isFinite(val) && !isNaN(val)) return Number(val);
        return 1;
      }
    }
    return 1;
  }

  function resolveDowMultiplier(map, dowKey, boatId){
    if(!dowKey) return 1;
    const row = map && map[dowKey];
    if(!row) return 1;
    const val = row[boatId] ?? row['*'] ?? row.default;
    return isFinite(val) && !isNaN(val) ? Number(val) : 1;
  }

  function resolveBusyMultiplier(levels, ratio, boatId){
    if(!levels || !levels.length || ratio===null || ratio===undefined) return 1;
    for(const level of levels){
      const from = typeof level.from==='number'? level.from : Number(level.from)||0;
      const toRaw = level.to;
      const to = (toRaw===null || toRaw===undefined || toRaw==='') ? null : Number(toRaw);
      const inRange = ratio >= from && (to===null ? ratio <= 1 : ratio <= to + 1e-9);
      if(inRange){
        const val = level.multipliers && (level.multipliers[boatId] ?? level.multipliers['*'] ?? level.multipliers.default);
        if(isFinite(val) && !isNaN(val)) return Number(val);
        break;
      }
    }
    return 1;
  }

  function createSheetPriceCalculator(pricing, occupancy, opts){
    const boatsMap = new Map();
    (pricing.boats||[]).forEach(b=>{
      boatsMap.set(b.id, {
        id: b.id,
        name: b.name || b.id,
        baseRate: Number(b.baseRate||0),
        minRate: b.minRate!==undefined && b.minRate!==null && b.minRate!=='' ? Number(b.minRate) : null,
        maxRate: b.maxRate!==undefined && b.maxRate!==null && b.maxRate!=='' ? Number(b.maxRate) : null,
        roundTo: b.roundTo!==undefined && b.roundTo!==null && b.roundTo!=='' ? Number(b.roundTo) : null
      });
    });
    const bands = (pricing.bands||[]).map(b=>({
      label: b.label||b.name||'',
      startMinutes: Number(b.startMinutes!==undefined? b.startMinutes : hmToMinutes(b.start)),
      endMinutes: Number(b.endMinutes!==undefined? b.endMinutes : hmToMinutes(b.end)),
      multipliers: b.multipliers||{}
    }));
    const dowMap = pricing.dowMultipliers || {};
    const specials = pricing.specialDates || {};
    const busyLevels = (pricing.busyLevels||[]).map(l=>({
      from: l.from,
      to: l.to,
      multipliers: l.multipliers||{}
    }));
    const defaultRound = pricing.defaultRoundTo ? Number(pricing.defaultRoundTo) : null;

    const sunsetBand = (pricing.bands||[]).find(b=> String(b.label||b.name||'').trim().toLowerCase()==='sunset');
    function bandMultiplierFor(band, boatId){
      const multipliers = band && band.multipliers || {};
      const val = multipliers[boatId] ?? multipliers['*'] ?? multipliers.default;
      return (isFinite(val) && !isNaN(val)) ? Number(val) : 1;
    }

    function daysAheadFromToday(slotDate){
      try{
        const slotYmd = isoDateInTZ(slotDate, TZ);
        const a = slotYmd.split('-').map(Number);
        const b = String(opts && opts.todayYMD || isoDateInTZ(new Date(), TZ)).split('-').map(Number);
        const da = Date.UTC(a[0], a[1]-1, a[2]);
        const db = Date.UTC(b[0], b[1]-1, b[2]);
        return Math.round((da - db)/86400000);
      }catch{return 0;}
    }

    function overlayPriceFor(boatId, slotStart, minute){
      try{
        const ymd = isoDateInTZ(slotStart, TZ);
        const daySpec = specials && specials[ymd];
        if(!daySpec || !daySpec.items || !daySpec.items.length) return null;
        let entry = daySpec.items.find(it=> (String(it.type||'')==='overlay' || String(it.type||'')==='Overlay' || String(it.type||'').toLowerCase()==='overlay') && (!it.boat || it.boat===boatId));
        if(!entry) return null;
        if(entry.start || entry.end){
          const sMin = entry.start ? hmToMinutes(entry.start) : 0;
          const eMin = entry.end ? hmToMinutes(entry.end) : 24*60;
          let inWin;
          if(sMin===eMin){ inWin = true; }
          else if(sMin < eMin){ inWin = minute >= sMin && minute < eMin; }
          else { inWin = (minute >= sMin) || (minute < eMin); }
          if(!inWin) return null;
        }
        const bandKey = (function(){
          for(const b of bands){
            const s=Number(b.startMinutes), e=Number(b.endMinutes);
            if(!isFinite(s)||!isFinite(e)) continue;
            let match;
            if(s===e) match=true; else if(s<e) match = minute>=s && minute<e; else match = minute>=s || minute<e;
            if(match){ return String((b.label||'').toLowerCase()); }
          }
          return '';
        })();
        const keyMap = { morning:'morning', day:'day', sunset:'sunset', evening:'night', night:'night' };
        const k = keyMap[bandKey] || bandKey;
        const price = entry.bands && entry.bands[k];
        if(price && isFinite(price)) return Number(price);
      }catch{}
      return null;
    }

    return (boatId, slotStart)=>{
      const boat = boatsMap.get(boatId);
      if(!boat || !boat.baseRate) return null;
      const parts = zonedDateParts(slotStart, TZ);
      const minute = parts.h*60 + parts.mi;
      const dowKey = DOW_SHORT_TO_KEY[parts.wd] || null;
      const occRatio = (opts && typeof opts.getOccupancyRatio==='function')
        ? opts.getOccupancyRatio(boatId, slotStart)
        : (occupancy && occupancy[boatId] ? occupancy[boatId].ratio : null);
      let bandMult;
      if(opts && typeof opts.inSunsetWindow==='function' && opts.inSunsetWindow(slotStart) && sunsetBand){
        bandMult = bandMultiplierFor(sunsetBand, boatId);
      } else {
        bandMult = resolveBandMultiplier(bands, minute, boatId);
      }
      let dowMult = resolveDowMultiplier(dowMap, dowKey, boatId);
      if (typeof opts.dowMinOcc === 'number'){
        const r = occRatio;
        if (!(r!==null && r!==undefined && r >= opts.dowMinOcc)){
          dowMult = 1;
        }
      }
      let busyMult;
      const horizon = (opts && isFinite(opts.occupancyHorizonDays)) ? Number(opts.occupancyHorizonDays) : null;
      const far = (opts && isFinite(opts.occupancyFarMultiplier)) ? Number(opts.occupancyFarMultiplier) : 1;
      if(horizon!==null){
        if(horizon <= 0){
          busyMult = far;
        }else if(daysAheadFromToday(slotStart) > horizon){
          busyMult = far;
        }else{
          busyMult = resolveBusyMultiplier(busyLevels, occRatio, boatId);
        }
      }else{
        busyMult = resolveBusyMultiplier(busyLevels, occRatio, boatId);
      }
      const overlay = overlayPriceFor(boatId, slotStart, minute);
      let price; let usedOverlay=false;
      if(overlay!==null){
        price = overlay; usedOverlay=true;
      } else {
        price = boat.baseRate * bandMult * dowMult * busyMult;
      }
      if(!usedOverlay){
        if(isFinite(boat.minRate) && boat.minRate!==null){ price = Math.max(boat.minRate, price); }
        if(isFinite(boat.maxRate) && boat.maxRate!==null && boat.maxRate>0){ price = Math.min(boat.maxRate, price); }
        const roundTo = boat.roundTo && boat.roundTo>0 ? boat.roundTo : (defaultRound && defaultRound>0 ? defaultRound : 0);
        if(roundTo>0){ price = Math.round(price/roundTo)*roundTo; }
      }
      return Math.round(price);
    };
  }

  function makeStatus(events, slotStart, slotEnd){
    for(const ev of events){ const s=new Date(ev.start), e=new Date(ev.end); if(s < slotEnd && e > slotStart) return 'busy'; }
    return 'free';
  }

  let weekOffset=0;
  // Booking UI state
  const state={ selection:null, sheetOpen:false, booking:{ paymentMethod:'cash', total:0, prepay:0, guests:1, contact:'', language:'', note:'' } };

  async function render(){
    const cfg=await loadConfig();
    log('cfg.endpoint', cfg.endpointUrl, 'pricingEndpoint', cfg.pricingEndpointUrl||'(none)');

    const baseToday = new Date();
    const nowP = zonedDateParts(baseToday, TZ);
    const nowYMD = `${nowP.y}-${pad2(nowP.m)}-${pad2(nowP.d)}`;
    const nowMinutes = nowP.h*60 + nowP.mi;
    const rangeStartInTz = addDays(baseToday, 7*weekOffset);
    const startYMD = isoDateInTZ(rangeStartInTz, TZ);
    const endYMD = isoDateInTZ(addDays(rangeStartInTz, 6), TZ);

    let sunsetsMap=null;
    if(cfg.sunsetFile && location.protocol!=='file:'){
      try{
        const r=await fetch(String(cfg.sunsetFile),{cache:'no-store'});
        if(r.ok){
          const arr=await r.json();
          const m=new Map();
          arr.forEach(x=>{
            if(x&&x.date&&x.sunset){
              const [hh,mm]=String(x.sunset).split(':').map(Number);
              m.set(String(x.date), {hh,mm,mins:hh*60+mm});
            }
          });
          sunsetsMap=m;
          log('sunsets loaded', m.size);
        }
      }catch(err){ log('sunsets load failed', err); }
    }

    const baseCombined = cfg.pricingEndpointUrl || cfg.endpointUrl;
    const key=`yachtCalendarCache|combined|${baseCombined}|${startYMD}`;
    let data=null; let pricing=null; let labelPrefix='';

    if(cfg.useDemo){
      pricing = await fetchPricingConfig(cfg);
      if(!pricing){ throw new Error('Pricing configuration unavailable'); }
      const demoSeedA = cfg.demoSeedA||42;
      const demoSeedB = cfg.demoSeedB||99;
      const openForDemo = pricing.open || cfg.open || '08:00';
      const closeForDemo = pricing.close || cfg.close || '23:00';
      const boatsForDemo = (pricing.boats||[]).map((b, idx)=>({
        id: b.id,
        name: b.name || b.id,
        events: demoEventsForWeek(rangeStartInTz, idx===0? demoSeedA : demoSeedB, openForDemo, closeForDemo)
      }));
      data = { tz: TZ, boats: boatsForDemo };
      labelPrefix='demo • ';
    } else {
      data = cacheGet(key, 10*60*1000);
      let usedCache=false;
      if(!data){
        app.innerHTML = `<div class="text-center text-sm text-gray-600">Loading ${startYMD}…</div>`;
        try{
          const extra = {};
          if(cfg.useTestCalendars) extra.test = 1;
          if(cfg.clientUid) extra.uid = cfg.clientUid;
          if(cfg.userId) extra.user = cfg.userId;
          if(cfg.userAgent) extra.ua = cfg.userAgent;
          // include user in cache key to avoid cross-user pricing cache
          const url = makeUrl(baseCombined, { start:startYMD, end:endYMD, tz:TZ, mode:'combined', client:'viewer', user: (cfg.userId||undefined), uid:(cfg.clientUid||undefined), ...extra });
          const useJsonp = shouldUseJsonp(baseCombined);
          log('fetch url', url, 'mode', useJsonp? 'jsonp':'fetch');
          data = useJsonp ? await fetchJsonp(url) : await fetchJson(url);
          cacheSet(key + (cfg.userId? `|u:${cfg.userId}`:''), data);
        }catch(err){
          const cachedAny = cacheGet(key, Infinity) || cacheGet(key + (cfg.userId? `|u:${cfg.userId}`:''), Infinity);
          if(cachedAny){ data=cachedAny; usedCache=true; }
          else { log('load failed', err); renderError('Load failed', String(err&&err.message||err)); return; }
        }
      }
      labelPrefix = usedCache? 'cached • ' : '';
      pricing = data && data.pricing ? data.pricing : null;
      if(!pricing){
        log('combined payload missing pricing, fetching separately');
        pricing = await fetchPricingConfig(cfg);
      }
    }

    if(!pricing){
      renderError('Pricing missing', 'Pricing configuration could not be loaded.');
      return;
    }
    if(pricing._nameById) delete pricing._nameById;

    const useSheetCfg = !!cfg.useSheetConfig;
    const openHM = useSheetCfg ? (pricing.open || cfg.open || '08:00') : (cfg.open || pricing.open || '08:00');
    const closeHM = useSheetCfg ? (pricing.close || cfg.close || '24:00') : (cfg.close || pricing.close || '24:00');
    const slotMins = Number(useSheetCfg ? (pricing.slotMins || cfg.slotMins || 60) : (cfg.slotMins || pricing.slotMins || 60));

    if(useSheetCfg && typeof pricing.showBusyDebug !== 'undefined') cfg.showBusyDebug = !!pricing.showBusyDebug;
    if(useSheetCfg && typeof pricing.occupancyMode === 'string'){
      cfg.occupancyMode = pricing.occupancyMode;
    }
    if(useSheetCfg && typeof pricing.occupancyAroundDays !== 'undefined' && pricing.occupancyAroundDays!==null){
      cfg.occupancyAroundDays = Number(pricing.occupancyAroundDays);
    }
    if(useSheetCfg && typeof pricing.occupancyHorizonDays !== 'undefined' && pricing.occupancyHorizonDays!==null){
      cfg.occupancyHorizonDays = Number(pricing.occupancyHorizonDays);
    }
    if(useSheetCfg && typeof pricing.occupancyFarMultiplier !== 'undefined' && pricing.occupancyFarMultiplier!==null){
      cfg.occupancyFarMultiplier = Number(pricing.occupancyFarMultiplier);
    }
    if(useSheetCfg && typeof pricing.dowMinOcc !== 'undefined' && pricing.dowMinOcc!==null){
      cfg.dowMinOcc = Number(pricing.dowMinOcc);
    }
    if(useSheetCfg && typeof pricing.pricingMethod === 'string'){
      cfg.pricingMethod = pricing.pricingMethod;
    }

    const boatsCfgById = new Map((pricing.boats||[]).map(b=> [b.id, b]));
    const boats = (data.boats || []).filter(b=> boatsCfgById.has(b.id));
    boats.forEach(b=>{
      const meta = boatsCfgById.get(b.id);
      if(meta && meta.name) b.name = meta.name;
    });

    const dayList = Array.from({length:7},(_,i)=> addDays(rangeStartInTz,i));
    const dayYMD = dayList.map(d=> isoDateInTZ(d, TZ));
    const specials = pricing.specialDates || {};
    function getDayHours(ymd){
      const spec = specials && specials[ymd];
      if(spec && Array.isArray(spec.items)){
        const overlay = spec.items.find(it=> String(it.type||'').toLowerCase()==='overlay' && (it.start || it.end));
        const any = spec.items.find(it=> (it.start || it.end));
        const pick = overlay || any;
        if(pick){ return { open: pick.start || openHM, close: pick.end || closeHM }; }
      }
      return { open: openHM, close: closeHM };
    }
    // Grid hours: by default show full day (off-hours allowed),
    // but if Special_DT defines a time window for this day, respect it.
    function getGridHours(ymd){
      // Simple original hours logic: prefer overlay window on the date, else any item
      // with start/end; otherwise use default open/close.
      const spec = specials && specials[ymd];
      if(spec && Array.isArray(spec.items)){
        const overlay = spec.items.find(it=> String(it.type||'').toLowerCase()==='overlay' && (it.start || it.end));
        const any = spec.items.find(it=> (it.start || it.end));
        const pick = overlay || any;
        if(pick){ return { open: pick.start || openHM, close: pick.end || closeHM }; }
      }
      return { open: openHM, close: closeHM };
    }

    const occMode = (cfg.occupancyMode||'week');
    const aroundDays = Number(cfg.occupancyAroundDays||1);
    const occWeek = computeOccupancy(boats, dayYMD, getDayHours);
    const occByDay = new Array(7);
    for(let i=0;i<7;i++){
      if(occMode==='week') { occByDay[i] = occWeek; continue; }
      if(occMode==='day') { occByDay[i] = computeOccupancy(boats, [dayYMD[i]], getDayHours); continue; }
      const start = Math.max(0, i - aroundDays);
      const end = Math.min(6, i + aroundDays);
      const slice = dayYMD.slice(start, end+1);
      occByDay[i] = computeOccupancy(boats, slice, getDayHours);
    }

    if(cfg.pricingMethod === 'normal'){
      cfg.occupancyHorizonDays = 0;
    }

    const sunsetBefore = Number(cfg.sunsetWindowBefore||0);
    const sunsetAfter  = Number(cfg.sunsetWindowAfter||0);
    function inSunsetWindow(dt){
      if(!sunsetsMap) return false;
      const ymd = isoDateInTZ(dt, TZ);
      const ss = sunsetsMap.get(ymd); if(!ss) return false;
      const mins = dt.getHours()*60 + dt.getMinutes();
      return mins >= (ss.mins - sunsetBefore) && mins < (ss.mins + sunsetAfter);
    }

    const priceAt = createSheetPriceCalculator(pricing, null, {
      inSunsetWindow,
      getOccupancyRatio: (boatId, slotStart)=>{
        const ymd = isoDateInTZ(slotStart, TZ);
        const idx = dayYMD.indexOf(ymd);
        const occ = (idx>=0? occByDay[idx] : occWeek) || occWeek;
        const rec = occ && occ[boatId];
        return rec? rec.ratio : null;
      },
      todayYMD: nowYMD,
      occupancyHorizonDays: (cfg.occupancyHorizonDays!==undefined? Number(cfg.occupancyHorizonDays) : undefined),
      occupancyFarMultiplier: (cfg.occupancyFarMultiplier!==undefined? Number(cfg.occupancyFarMultiplier) : undefined),
      dowMinOcc: (cfg.dowMinOcc!==undefined? Number(cfg.dowMinOcc) : undefined)
    });

    function statusFor(events, slotStart, slotEnd){ return makeStatus(events, slotStart, slotEnd); }

    function HourlyDay(dayYMD){
      const rows=[];
      const dayHours = getGridHours(dayYMD);
      const openM = hmToMinutes(dayHours.open);
      const closeMRaw = hmToMinutes(dayHours.close);
      const step=slotMins;
      const totalMinutes = minutesDiffWrap(openM, closeMRaw);
      let steps = Math.ceil(totalMinutes/step);
      for(let n=0;n<steps;n++){
        const minuteValue = (openM + n*step) % (24*60);
        const slotStart = dateAtMinutes(dayYMD, minuteValue);
        let slotEnd = new Date(slotStart.getTime() + step*60000);
        const h12=((Math.floor(minuteValue/60)+11)%12)+1;
        const mm=minuteValue%60;
        const labelCore = mm===0 ? `${h12} ${minuteValue<720?'AM':'PM'}` : `${h12}:${String(mm).padStart(2,'0')} ${minuteValue<720?'AM':'PM'}`;
        const cells = boats.map(b=>{
          const st = statusFor(b.events||[], slotStart, slotEnd);
          const price = st==='free'? priceAt(b.id, slotStart) : null;
          return {id:b.id, status: st, price};
        });
        const isTodayDubai = (dayYMD===nowYMD);
        const minsNow = minuteValue;
        const isNow = isTodayDubai && (minsNow <= nowMinutes) && (nowMinutes < minsNow + step);
        const inSun = sunsetsMap ? inSunsetWindow(slotStart) : false;
        rows.push({minute: minuteValue, label: labelCore, cells, sunset: inSun, now: isNow});
      }
      return rows;
    }

    function DayHeader(d, i){
      const todayIso = isoDateInTZ(new Date(), TZ);
      const isToday = todayIso === isoDateInTZ(d, TZ);
      let specialsUi='';
      let dbg='';
      try{
        const ymdVis = isoDateInTZ(d, TZ);
        const specVis = (pricing.specialDates||{})[ymdVis];
        if(specVis && Array.isArray(specVis.items) && specVis.items.length){
          const rows=[];
          const names = Array.from(new Set(specVis.items.map(it=> String(it.name||'').trim()).filter(Boolean)));
          const dayName = names.join(', ');
          const first12 = specVis.items.find(it=> it.p12h && isFinite(it.p12h));
          const first24 = specVis.items.find(it=> it.p24h && isFinite(it.p24h));
          const badgeKind = first24? '24h' : (first12? '12h' : '');
          const badgeAmount = first24? Number(first24.p24h) : (first12? Number(first12.p12h) : null);
          if(dayName){
            const sizeCls = (window.innerWidth<420? 'text-xl' : 'text-base');
            rows.push(`<div class=\"mt-1 text-center\"><span class=\"${sizeCls} font-semibold text-violet-700\" style=\"line-height:1.2\">${dayName}</span></div>`);
          }
          if(badgeKind && badgeAmount!==null){
            const badge = `<div class=\"inline-flex items-center rounded-full bg-gray-100 text-gray-700 px-3 py-1 text-[11px] font-medium whitespace-nowrap leading-none\">${badgeKind} ${badgeAmount.toLocaleString('en')} AED</div>`;
            rows.push(`<div class=\"mt-1 flex justify-end\">${badge}</div>`);
          }
          const offers = specVis.items.filter(it=> String(it.type||'').toLowerCase()!=='overlay');
          offers.slice(0,3).forEach(it=>{
            const boatLbl = it.boat? (boatsCfgById.get(it.boat)?.name || it.boat) : '';
            const min = (it.minOrder && isFinite(it.minOrder))? (`min ${it.minOrder}h`) : '';
            const title=[it.name||'Offer', boatLbl].filter(Boolean).join(' • ');
            const line=[min].filter(Boolean).join(' • ');
            rows.push(`<div class=\"px-2 py-1 rounded-lg bg-emerald-50 text-emerald-800 text-[11px] text-center\">${title}${line? ' — '+line : ''}</div>`);
          });
          const noteItem = specVis.items.find(it=> (it.note && String(it.note).trim().length>0));
          const noteBlock = noteItem? `<div class=\"mt-1 text-[10px] text-gray-600 italic\">${String(noteItem.note).trim()}</div>` : '';
          if(rows.length || noteBlock){ specialsUi = `<div class=\"mt-1 flex flex-col items-center gap-1\">${rows.join('')} ${noteBlock}</div>`; }
        }
      }catch{}
      try{
        const showDbg = !!cfg.showBusyDebug;
        if(showDbg){
          const ymd = isoDateInTZ(d, TZ);
          const occ = occByDay[i] || occWeek;
          const parts=[];
          const horizon = Number(cfg.occupancyHorizonDays);
          const farMult = Number(cfg.occupancyFarMultiplier||1);
          const p = zonedDateParts(d, TZ);
          const dowKey = DOW_SHORT_TO_KEY[p.wd] || null;
          const dowMap = pricing.dowMultipliers || {};
          (boats||[]).forEach(b=>{
            const o = occ && occ[b.id];
            const r = (o && typeof o.ratio==='number') ? Math.round(o.ratio*100) : null;
            let busyM = 1; let busyTag='busy';
            if(Number.isFinite(horizon)){
              try{
                const nowP = todayIso.split('-').map(Number);
                const dP = ymd.split('-').map(Number);
                const daysAhead = Math.round((Date.UTC(dP[0], dP[1]-1, dP[2]) - Date.UTC(nowP[0], nowP[1]-1, nowP[2]))/86400000);
                if(horizon <= 0 || daysAhead > horizon){ busyM = Number.isFinite(farMult)? farMult : 1; busyTag='far'; }
                else {
                  const info = resolveBusyInfo(pricing.busyLevels||[], o? o.ratio : null, b.id);
                  busyM = (info && Number.isFinite(info.mult))? Number(info.mult) : 1;
                }
              }catch{ busyM = 1; }
            } else {
              const info = resolveBusyInfo(pricing.busyLevels||[], o? o.ratio : null, b.id);
              busyM = (info && Number.isFinite(info.mult))? Number(info.mult) : 1;
            }
            const dowRaw = resolveDowMultiplier(dowMap, dowKey, b.id);
            const dowM = (typeof cfg.dowMinOcc === 'number' && !(o && (o.ratio>=cfg.dowMinOcc))) ? 1 : dowRaw;
            const total = busyM * dowM;
            const occStr = (r!==null? (r+'%') : '—');
            const pieces = [];
            pieces.push(`${occStr} ×${busyM.toFixed(2)}${busyTag==='far'?'(far)':''}`);
            pieces.push(`dow ×${(Number.isFinite(dowM)? dowM.toFixed(2):'1.00')}`);
            pieces.push(`= ×${total.toFixed(2)}`);
            parts.push(`${b.name||b.id}: ${pieces.join(' • ')}`);
          });
          let typeLabel = 'динамический';
          if(Number.isFinite(horizon)){
            try{
              if(horizon <= 0){
                typeLabel = 'нормальный';
              } else {
                const nowP = todayIso.split('-').map(Number);
                const dP = ymd.split('-').map(Number);
                const daysAhead = Math.round((Date.UTC(dP[0], dP[1]-1, dP[2]) - Date.UTC(nowP[0], nowP[1]-1, nowP[2]))/86400000);
                if(daysAhead > horizon) typeLabel = 'нормальный';
              }
            }catch{}
          }
          const spec = (pricing.specialDates||{})[ymd];
          let specStr = '';
          if(spec && Array.isArray(spec.items) && spec.items.length){
            const overlays = spec.items.filter(it=> String(it.type||'').toLowerCase()==='overlay');
            const offers = spec.items.filter(it=> String(it.type||'').toLowerCase()!=='overlay');
            if(overlays.length){ specStr += ` • overlay`; }
            if(offers.length){
              const first = offers.slice(0,2).map(it=> it.name||'Offer').join(', ');
              specStr += ` • offers: ${first}${offers.length>2? '…':''}`;
            }
          }
          const dayHoursDbg = (function(){ const h=getDayHours(ymd); return (h && (h.open!==openHM||h.close!==closeHM))? ` • hours ${h.open}–${h.close}` : ''; })();
          const typeStr = `тип: ${typeLabel}${specStr}${dayHoursDbg}`;
          const modeLabel = (occMode==='day'? 'day' : (occMode==='around'? `±${aroundDays}d` : 'week'));
          dbg = `<div class="text-[10px] text-gray-500">${typeStr} • occ: ${modeLabel} • ${parts.join(' • ')}</div>`;
        }
      }catch{}
      return `<div class="${window.innerWidth<420? 'text-xl' : 'text-base'} font-semibold ${isToday? 'text-blue-700':'text-gray-700'}">${fmt(d,{weekday:'short'})} <span class="opacity-70">${fmt(d,{day:'2-digit',month:'short'})}</span></div>${specialsUi}${dbg}`;
    }

    const isSmall = window.innerWidth < 420;
    const gridTimeCol = isSmall? 64 : 90;
    const gridLineCol = isSmall? 4 : 8;
    const gridGap = isSmall? 8 : 12;
    const rowH = isSmall? 28 : 36;

    const weekEnd = addDays(rangeStartInTz,6);
    const header = `
      <div class="flex flex-col items-center gap-2 mb-4 text-center">
        <h1 class="font-semibold tracking-tight text-2xl">Imperial Yachting</h1>
        <p class="text-sm text-gray-600">Intervals • ${labelPrefix}${fmt(rangeStartInTz,{month:'short',day:'2-digit'})} — ${fmt(weekEnd,{month:'short',day:'2-digit'})} • ${TZ}</p>
        <div class="flex items-center gap-2">
          <button class="px-3 py-2 rounded-xl bg-white shadow" onclick="weekOffset--; render()">←</button>
          <button class="px-3 py-2 rounded-xl bg-white shadow" onclick="weekOffset++; render()">→</button>
          <button class="px-3 py-2 rounded-xl bg-indigo-600 text-white shadow" onclick="forceRefresh()">Refresh</button>
        </div>
      </div>`;

    const content = dayYMD.map((ymd,i)=>{
      const rows = HourlyDay(ymd);
      const boatNames = boats.map(b=> boatsCfgById.get(b.id)?.name || b.name || b.id);
      return `
        <div class="bg-white rounded-2xl shadow p-3 mb-3">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">${DayHeader(dayList[i], i)}</div>
          </div>
          <div class="grid" style="grid-template-columns:${gridLineCol}px ${gridTimeCol}px ${boats.length? 'repeat('+boats.length+', 1fr)' : ''}; gap:${gridGap}px; align-items:center; grid-auto-rows:auto;">
            <div></div><div></div>
            ${boatNames.map(n=> `<div class=\"${isSmall?'text-sm':'text-sm'} font-semibold text-gray-700 text-center pb-1\">${n}</div>`).join('')}
            ${rows.map(r=> `
              <div style="height:${rowH}px; position:relative; display:flex; align-items:center; justify-content:center;">
                ${r.sunset? `<div style=\"position:absolute; width:${isSmall?2:3}px; height:100%; background:#f59e0b; border-radius:9999px\"></div>` : ''}
                ${r.now? '<div style=\"width:6px; height:6px; background:#3b82f6; border-radius:9999px; box-shadow:0 0 0 2px rgba(255,255,255,0.85)\"></div>' : ''}
              </div>
              <div class="${isSmall?'text-base':'text-sm'} text-gray-700 tn-nums text-right ${isSmall?'pr-2':'pr-3'} flex items-center justify-end" style="height:${rowH}px;">${r.label}</div>
              ${r.cells.map(c=> {
                const isSel = state.selection && state.selection.ymd===ymd && state.selection.boatId===c.id && r.minute>=state.selection.startMinute && r.minute < (state.selection.startMinute + state.selection.duration);
                if(c.status==='free'){
                  const cls = `w-full rounded-lg ${isSel? 'bg-indigo-50 slot-selected':'bg-green-100'} text-green-900 ${isSmall?'text-[11px]':'text-xs'} flex items-center justify-center cursor-pointer`;
                  const label = `${c.price ?? '—'} AED`;
                  return `<div class=\"${cls}\" data-boat=\"${c.id}\" data-ymd=\"${ymd}\" data-minute=\"${r.minute}\" style=\"height:${rowH}px\">${label}</div>`;
                }
                if(c.status==='busy') return `<div class=\"w-full rounded-lg bg-red-300/80 text-[11px] text-red-900 flex items-center justify-center\" style=\"height:${rowH}px\">Busy</div>`;
                return `<div class=\"w-full ${isSmall?'text-[11px]':'text-xs'} text-gray-300 flex items-center justify-center\" style=\"height:${rowH}px\">—</div>`;
              }).join('')}
            `).join('')}
          </div>
        </div>`;
    }).join('');

    app.innerHTML = header + `<div class="mx-auto ${isSmall?'max-w-sm':'max-w-4xl'}">` + content + `</div>` + `<div id="sheet"></div>` + `<div id="fab"></div>`;

    // Selection handlers
    app.querySelectorAll('[data-boat]').forEach(el=>{
      el.addEventListener('click',()=>{
        const boatId=el.getAttribute('data-boat'); const ymd=el.getAttribute('data-ymd'); const minute=Number(el.getAttribute('data-minute')||0);
        const step=slotMins;
        const remain = Math.max(step, (24*60 - minute));
        const desired = step*2;
        let duration = Math.max(step, Math.floor(Math.min(desired, remain)/step)*step);
        const boatName = boatsCfgById.get(boatId)?.name || boatId;
        state.selection={ boatId, boatName, ymd, startMinute:minute, duration, step };
        state.sheetOpen=false;
        renderBookingSheet(pricing, boats, priceAt);
        updateSelectionHighlight();
        renderFab(pricing, boats, priceAt);
      });
    });

    // Render sheet after grid
    renderBookingSheet(pricing, boats, priceAt);
    renderFab(pricing, boats, priceAt);

    // expose helpers for sheet controls
    window.updateSelectionHighlight = updateSelectionHighlight;

    function updateSelectionHighlight(){
      const sel=state.selection;
      const nodes=app.querySelectorAll('[data-boat]');
      if(!sel){
        // reset all free cells to default look
        nodes.forEach(n=>{ n.classList.remove('slot-selected','bg-indigo-50'); n.classList.add('bg-green-100'); });
        return;
      }
      const start=sel.startMinute, end=sel.startMinute + sel.duration;
      nodes.forEach(n=>{
        const nBoat=n.getAttribute('data-boat');
        const nYmd=n.getAttribute('data-ymd');
        const m=Number(n.getAttribute('data-minute')||0);
        const inSel = (nBoat===sel.boatId) && (nYmd===sel.ymd) && (m>=start && m<end);
        if(inSel){
          n.classList.add('slot-selected','bg-indigo-50');
          n.classList.remove('bg-green-100');
        } else {
          n.classList.remove('slot-selected','bg-indigo-50');
          n.classList.add('bg-green-100');
        }
      });
    }
  }

  function sumSelectedPrice(sel, priceAt){
    if(!sel) return 0; const {boatId, ymd, startMinute, duration, step}=sel; const slots=Math.ceil(duration/step); let total=0;
    for(let i=0;i<slots;i++){
      const m=(startMinute + i*step)%(24*60); const s=dateAtMinutes(ymd, m); const v=priceAt(boatId, s); if(!isFinite(v)) return 0; total+=Number(v||0);
    }
    return total;
  }

  // simplified mode: we don't block by busy here; UI still shows Busy, but booking UI ignores it

  function renderBookingSheet(pricing, boats, priceAt){
    const sheet=document.getElementById('sheet'); if(!sheet) return;
    const sel=state.selection; const invalidBusy = false;
    let minDurWarn=''; let invalidMin=false; let minDurMins=0;
    const invalid = false;
    let summary='';
    if(sel){
      const h=Math.floor(sel.duration/60), m=sel.duration%60; const hStr = h? `${h}h` : ''; const mStr = m? `${m}m` : ''; const durStr = [hStr,mStr].filter(Boolean).join(' ');
      const total=sumSelectedPrice(sel, priceAt); state.booking.total=total;
      const dateStr = sel.ymd;
      summary = `${sel.boatName} • ${dateStr} • ${durStr}`;
    }
    const balanceDue = Math.max(0, Number(state.booking.total||0) - Number(state.booking.prepay||0));
    sheet.innerHTML = `
      <div class="fixed inset-0 bg-black/30 ${state.sheetOpen? '' : 'hidden'}" id="sheetMask"></div>
      <div class="fixed left-0 right-0 bottom-0 sheet bg-white rounded-t-2xl shadow-2xl ${state.sheetOpen? 'sheet-open':'sheet-enter'}" id="sheetPanel">
        <div class="p-4 border-b flex items-center justify-between">
          <div class="font-semibold">Booking</div>
          <button class="px-3 py-1 rounded-lg bg-gray-100" id="btnClose">Close</button>
        </div>
        <div class="p-4">
          <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
            <div class="text-sm text-gray-700">${summary || 'No selection'}</div>
            <div class="flex items-center gap-2">
              <button class="px-2 py-1 rounded-lg bg-gray-100" id="btnShiftLeft">-30m</button>
              <button class="px-2 py-1 rounded-lg bg-gray-100" id="btnMinus">-</button>
              <div class="px-3 py-1 rounded-lg bg-gray-50 tn-nums" id="durLbl"></div>
              <button class="px-2 py-1 rounded-lg bg-gray-100" id="btnPlus">+</button>
              <button class="px-2 py-1 rounded-lg bg-gray-100" id="btnShiftRight">+30m</button>
            </div>
          </div>
          

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-medium mb-2">Payments</div>
              <label class="block text-sm mb-2">Payment method
                <select class="mt-1 w-full border rounded-lg p-2" id="payMethod">
                  <option value="cash">Cash</option>
                  <option value="account">Account</option>
                  <option value="stripe">Stripe</option>
                </select>
              </label>
              <div class="text-sm mb-2">Total amount: <span class="font-semibold tn-nums" id="totalAmt">${(state.booking.total||0).toLocaleString('en')} AED</span></div>
              <label class="block text-sm mb-2">Prepayment
                <input type="number" min="0" step="50" class="mt-1 w-full border rounded-lg p-2 tn-nums" id="prepay" value="${Number(state.booking.prepay||0)}" />
              </label>
              <div class="text-sm">Balance due on board: <span class="font-semibold tn-nums" id="balance">${balanceDue.toLocaleString('en')} AED</span></div>
            </div>

            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-medium mb-2">Guest</div>
              <label class="block text-sm mb-2">Number of guests
                <input type="number" min="1" max="50" class="mt-1 w-full border rounded-lg p-2" id="guests" value="${Number(state.booking.guests||1)}" />
              </label>
              <label class="block text-sm mb-2">Guest contact
                <input type="text" placeholder="Phone / Email" class="mt-1 w-full border rounded-lg p-2" id="contact" value="${state.booking.contact||''}" />
              </label>
              <label class="block text-sm mb-2">Trip language
                <input type="text" class="mt-1 w-full border rounded-lg p-2" id="lang" value="${state.booking.language||''}" />
              </label>
            </div>

            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-medium mb-2">Additional</div>
              <label class="block text-sm mb-2">Custom note
                <textarea rows="5" class="mt-1 w-full border rounded-lg p-2" id="note">${state.booking.note||''}</textarea>
              </label>
            </div>
          </div>

          <div class="mt-4 flex justify-end gap-2">
            <button class="px-4 py-2 rounded-lg bg-white border" id="btnDiscard">Discard</button>
            <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-50" id="btnSubmit" ${invalid? 'disabled':''}>Book</button>
          </div>
        </div>
      </div>`;

    const durLbl=document.getElementById('durLbl'); if(durLbl && sel){ const h=Math.floor(sel.duration/60), m=sel.duration%60; durLbl.textContent = `${h? h+'h ':''}${m? m+'m':''}` || '0m'; }
    const mask=document.getElementById('sheetMask'); const close=document.getElementById('btnClose'); const discard=document.getElementById('btnDiscard');
    function closeSheet(){ state.sheetOpen=false; renderBookingSheet(pricing, boats, priceAt); renderFab(pricing, boats, priceAt); }
    mask&&mask.addEventListener('click', closeSheet); close&&close.addEventListener('click', closeSheet); discard&&discard.addEventListener('click', ()=>{ state.selection=null; closeSheet(); render(); });
    const plus=document.getElementById('btnPlus'); const minus=document.getElementById('btnMinus'); const shL=document.getElementById('btnShiftLeft'); const shR=document.getElementById('btnShiftRight');
    function adjustDur(delta){
      if(!state.selection) return;
      const step=state.selection.step;
      let next = Math.max(step, state.selection.duration + delta);
      const remain = Math.max(step, (24*60 - state.selection.startMinute));
      if(next > remain) next = remain;
      state.selection.duration = next;
      updateSelectionHighlight(); renderBookingSheet(pricing, boats, priceAt); renderFab(pricing, boats, priceAt);
    }
    function shiftBy(delta){
      if(!state.selection) return;
      const step=state.selection.step;
      const newStart = ((state.selection.startMinute + delta)%(24*60)+24*60)%(24*60);
      const remain = Math.max(step, (24*60 - newStart));
      if(state.selection.duration > remain){ state.selection.duration = remain; }
      state.selection.startMinute = newStart;
      updateSelectionHighlight(); renderBookingSheet(pricing, boats, priceAt); renderFab(pricing, boats, priceAt);
    }
    plus&&plus.addEventListener('click', ()=>adjustDur(state.selection? state.selection.step:60));
    minus&&minus.addEventListener('click', ()=>adjustDur(-(state.selection? state.selection.step:60)));
    shL&&shL.addEventListener('click', ()=>shiftBy(-30)); shR&&shR.addEventListener('click', ()=>shiftBy(30));
    const prepay=document.getElementById('prepay'); prepay&&prepay.addEventListener('input',()=>{ state.booking.prepay = Number(prepay.value||0); renderBookingSheet(pricing, boats, priceAt); });
    const pm=document.getElementById('payMethod'); pm&&pm.addEventListener('change',()=>{ state.booking.paymentMethod=pm.value; });
    const guests=document.getElementById('guests'); guests&&guests.addEventListener('input',()=>{ state.booking.guests=Number(guests.value||1); });
    const contact=document.getElementById('contact'); contact&&contact.addEventListener('input',()=>{ state.booking.contact=contact.value; });
    const lang=document.getElementById('lang'); lang&&lang.addEventListener('input',()=>{ state.booking.language=lang.value; });
    const note=document.getElementById('note'); note&&note.addEventListener('input',()=>{ state.booking.note=note.value; });
    const submit=document.getElementById('btnSubmit'); submit&&submit.addEventListener('click',()=>{
      const payload={
        when: new Date().toISOString(),
        selection: state.selection,
        pricingInfo: { total: state.booking.total },
        payment: { method: state.booking.paymentMethod, prepay: Number(state.booking.prepay||0), balance: Math.max(0, Number(state.booking.total||0)-Number(state.booking.prepay||0)) },
        guest: { count: Number(state.booking.guests||1), contact: state.booking.contact||'', language: state.booking.language||'' },
        note: state.booking.note||''
      };
      console.log('BOOKING_SUBMIT', payload);
      alert('Booking payload logged to console. Backend integration TBD.');
      state.sheetOpen=false; renderBookingSheet(pricing, boats, priceAt); renderFab(pricing, boats, priceAt);
    });
    const totalLbl=document.getElementById('totalAmt'); if(totalLbl) totalLbl.textContent = `${(state.booking.total||0).toLocaleString('en')} AED`;
    const bal=document.getElementById('balance'); if(bal) bal.textContent = `${(Math.max(0, Number(state.booking.total||0)-Number(state.booking.prepay||0))).toLocaleString('en')} AED`;
  }

  function renderFab(pricing, boats, priceAt){
    const fab=document.getElementById('fab'); if(!fab) return;
    const sel=state.selection; if(!sel){ fab.innerHTML=''; return; }
    const invalid = false;
    const total = sumSelectedPrice(sel, priceAt);
    const h=Math.floor(sel.duration/60), m=sel.duration%60; const durStr=`${h? h+'h ':''}${m? m+'m':''}`.trim()||'0m';
    fab.innerHTML = `
      <div class="fixed right-4 bottom-4 flex gap-2 items-center">
        <button id="fabReset" class="px-3 py-2 rounded-full bg-white border shadow">Reset</button>
        <button id="fabBook" ${invalid?'disabled':''} class="px-4 py-3 rounded-full shadow-lg ${invalid? 'bg-gray-300 text-gray-600 cursor-not-allowed':'bg-indigo-600 text-white'}">
          Book • ${durStr} • ${Number(total||0).toLocaleString('en')} AED
        </button>
      </div>`;
    const btn=document.getElementById('fabBook');
    if(btn && !invalid){ btn.onclick=()=>{ state.sheetOpen=true; renderBookingSheet(pricing, boats, priceAt); }; }
    const reset=document.getElementById('fabReset');
    if(reset){ reset.onclick=()=>{ state.selection=null; renderBookingSheet(pricing, boats, priceAt); renderFab(pricing, boats, priceAt); updateSelectionHighlight(); }; }
  }

  function maxContiguousFreeMinutes(boats, boatId, ymd, startMinute, step){
    const boat=boats.find(b=> b.id===boatId); if(!boat) return step;
    const evs=(boat.events||[]);
    let total=0; let m=startMinute;
    for(let guard=0; guard<Math.ceil(1440/step); guard++){
      const s=dateAtMinutes(ymd, m); const e=new Date(s.getTime()+step*60000);
      if(makeStatus(evs, s, e)!=='free') break;
      total += step;
      const nextM = (m + step) % (24*60);
      // Do not wrap over midnight: stop at the day boundary
      if(nextM <= m) break;
      m = nextM;
    }
    return Math.max(step, total);
  }

  // Lightweight toast/notice
  function showNotice(msg){
    try{
      let t=document.getElementById('yc_toast');
      if(!t){ t=document.createElement('div'); t.id='yc_toast'; document.body.appendChild(t); }
      t.className='fixed left-1/2 -translate-x-1/2 top-4 z-50';
      t.innerHTML = `<div class="px-3 py-2 rounded-lg bg-black/80 text-white text-sm shadow">${msg}</div>`;
      clearTimeout(t._timer);
      t._timer=setTimeout(()=>{ if(t) t.innerHTML=''; }, 2500);
    }catch{}
  }

// simplified mode: minimum duration is controlled only by UI step and day end

  async function forceRefresh(){
    const cfg=await loadConfig();
    const baseToday=new Date();
    const rangeStartInTz = addDays(baseToday, 7*weekOffset);
    const startYMD = isoDateInTZ(rangeStartInTz, TZ);
    const baseCombined = cfg.pricingEndpointUrl || cfg.endpointUrl;
    const key=`yachtCalendarCache|combined|${baseCombined}|${startYMD}`;
    try{ localStorage.removeItem(key); localStorage.removeItem(key + (cfg.userId? `|u:${cfg.userId}`:'')); }catch{}
    render();
  }

  render();
  </script>
</body>
</html>
